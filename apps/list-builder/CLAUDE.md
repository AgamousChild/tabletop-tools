# CLAUDE.md â€” list-builder

> Read SOUL.md first. Every decision here flows from it.

---

## Current State

| Layer | Status |
|---|---|
| DB schema (unit_ratings, lists, list_units) | âœ… in packages/db |
| packages/game-content BSDataAdapter | âœ… built + tested |
| Server scaffold | ğŸ”² not started |
| Client scaffold | ğŸ”² not started |

---

## What This App Is

list-builder is a smart army list builder for Warhammer 40K where every unit carries a live performance rating derived from real GT+ tournament data. As you build a list, it surfaces higher-rated alternatives at the same points cost. Ratings update as new event data comes in and reset when GW releases a new balance dataslate or codex.

---

## Platform Context

```
tabletop-tools/
  packages/
    ui/             â† shared components, dark theme, Geist, shadcn
    auth/           â† shared Better Auth
    db/             â† shared Turso schema and Drizzle client
    game-content/   â† GameContentAdapter interface + BSDataAdapter
  apps/
    list-builder/   â† this app
```

Server port: **3003**

---

## Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Tier 1: React Client           â”‚
â”‚  - Faction selector             â”‚
â”‚  - Unit browser + search        â”‚
â”‚  - List builder (add/remove)    â”‚
â”‚  - Rating badges + suggestions  â”‚
â”‚  - tRPC client (type-safe)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚ tRPC over HTTP
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Tier 2: tRPC Server            â”‚
â”‚  - Auth router                  â”‚
â”‚  - List router                  â”‚
â”‚  - Unit router (BSData)         â”‚
â”‚  - Rating router (BCP data)     â”‚
â”‚  - SQLite via Turso             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Stack

Same as the platform. No additions without a reason.

| Layer | Choice |
|---|---|
| Language | TypeScript |
| Runtime | Node.js |
| Bundler | Vite |
| Test Runner | Vitest |
| API | tRPC + Zod |
| UI | React + Tailwind + shadcn |
| Database | Turso (libSQL/SQLite) via Drizzle |
| Auth | Better Auth (shared) |

---

## Data Sources

### Unit Profiles: BSData (via GameContentAdapter)
The platform ships **zero GW content**. Unit profiles are loaded at runtime from the operator's local BSData clone via `BSDataAdapter`. No unit data is stored in the DB.

```
BSDATA_DIR=/path/to/bsdata-clone/wh40k-10e
```

If `BSDATA_DIR` is not set, `NullAdapter` is used and unit searches return empty arrays. Shared adapter pattern with `apps/versus` â€” same `GameContentAdapter` interface.

### Ratings: Native match records + imported tournament data
Ratings are derived entirely from match data generated by users of this instance:

- **Native match records** â€” games tracked in `apps/game-tracker` with `is_tournament = 1`
- **Imported tournament results** â€” external CSV files the operator imports via the admin panel
  (BCP export, Tabletop Admiral export, or the platform's generic CSV format)
- No BCP scraping. The operator obtains external data themselves and imports it.
- Ratings reset on dataslate/codex â€” `meta_window` label changes and a fresh window begins

---

## Database Schema

No `units` table. Unit data lives in memory via `GameContentAdapter`.
`unit_content_id` columns are plain TEXT â€” no FK into game content.
`unit_name` and `unit_points` are denormalized at add-time.

```typescript
// unit_ratings  (derived from native + imported match data)
id               TEXT PRIMARY KEY
unit_content_id  TEXT NOT NULL      -- content adapter ID â€” NOT a DB FK
rating           TEXT NOT NULL      -- S / A / B / C / D
win_contrib      REAL NOT NULL
pts_eff          REAL NOT NULL
meta_window      TEXT NOT NULL      -- e.g. "2025-Q2" â€” resets on dataslate
computed_at      INTEGER NOT NULL

// lists
id         TEXT PRIMARY KEY
user_id    TEXT NOT NULL
faction    TEXT NOT NULL      -- user-entered string
name       TEXT NOT NULL
total_pts  INTEGER NOT NULL
created_at INTEGER NOT NULL
updated_at INTEGER NOT NULL

// list_units
id               TEXT PRIMARY KEY
list_id          TEXT NOT NULL      -- references lists.id
unit_content_id  TEXT NOT NULL      -- content adapter ID â€” NOT a DB FK
unit_name        TEXT NOT NULL      -- denormalized at add-time
unit_points      INTEGER NOT NULL   -- denormalized at add-time
count            INTEGER NOT NULL
```

---

## tRPC Routers

```typescript
// Units
unit.search({ faction?, query? })          â†’ unit[]
unit.get(id)                               â†’ unit + rating

// Ratings
rating.get(unitId)                         â†’ { rating, winContrib, ptsEff }
rating.alternatives({ unitId, ptsRange? }) â†’ unit[]  -- same role, sorted by rating

// Lists
list.create({ faction, name })             â†’ list
list.get(id)                               â†’ list + all units + ratings
list.list()                                â†’ list[]
list.addUnit({ listId, unitId, count? })
list.removeUnit({ listId, unitId })
list.delete(id)
```

---

## Rating System

Ratings are letter grades: **S, A, B, C, D**

Computed from:
- **Win-rate contribution**: how much does including this unit correlate with winning GT events
- **Points efficiency**: performance per point spent

Suggestions surface when you add a unit:
```
You added: Redemptor Dreadnought  85pts  Rating: C+
Suggestion: Brutalis Dreadnought  90pts  Rating: A-
            (+5pts, significantly stronger in the current meta)
```

Ratings reset to null when a new balance dataslate or codex drops. The meta window label (e.g. `"2025-Q2"`) changes and a fresh window begins â€” old data is excluded from new-window queries.

---

## User Flow

```
Login
  â†’ Select faction
  â†’ Browse units with ratings visible
  â†’ Add unit to list
    â†’ See live points total
    â†’ See suggestion if a higher-rated option exists at similar cost
  â†’ Save list
  â†’ Export (text format for BCP / tournament submission)
```

---

## UI Notes

Same design tokens as the platform (slate-950 background, amber-400 accent, Geist).

Rating badge:
```
[ A- ]  â† green for S/A, amber for B/C, red for D
```

Unit card:
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Brutalis Dreadnought        [ A- ] â”‚
â”‚  90pts  Â·  Space Marines            â”‚
â”‚  T10  Sv2+  W12  Â·  Melee          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Rules for Every Session

See root `CLAUDE.md` â€” Rules for Every Session.

App-specific: **Ratings must be derived correctly. Test the scoring logic.**

---

## Testing: TDD Required

Tests before code. No exceptions.

```
src/
  lib/
    ratings/
      score.ts
      score.test.ts
```

BSData parsing lives in `packages/game-content` â€” do not duplicate it here.

There is no BCP scraper. Rating data comes exclusively from:
- Native match records in `apps/game-tracker` where `is_tournament = 1`
- CSV files the operator imports via the admin panel (BCP export, Tabletop Admiral, generic)

The operator obtains external tournament data themselves and imports it. This platform
never makes external network requests to BCP or any other service.

Meta window labels are shared with `apps/new-meta` â€” the same imported tournament data
feeds both the rating engine here and the aggregate analytics there.
